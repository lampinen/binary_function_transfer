---
title: "Meta analyses (lol)"
output: html_notebook
---
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
theme_set(theme_bw() +
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
```

```{r}
meta_mapping_tasks = c("ID", "NOT")
meta_classification_tasks = c("isX0", "isNOTX0", "isAND", "isOR", "isNOTAND", "isXOR", "isNOTXOR")
truly_new_tasks = c("NOTOR")
nruns = 30
```

```{r}
d = data.frame()
for (run_i in 0:(nruns-1)) {
  filename = sprintf("meta_results/run%i_new_new_losses.csv", run_i)
  if (!file.exists(filename)) {
    next
  }
  this_d = read.csv(filename, header=T)
  this_d$run = run_i
  this_d = this_d %>% 
    select(run, epoch, contains("new")) %>%
    gather(new_task, loss, contains("new")) %>%
    mutate(new_task=gsub("\\..*","",new_task))

  d = bind_rows(d, this_d)
}
```

```{r}
task_truly_new =  function(tasks) {
  return(any(vapply(truly_new_tasks, function(x) grepl(x, tasks), T)))
} 
task_truly_new = Vectorize(task_truly_new)
```

```{r}
d = d %>%
  mutate(condition = ifelse(task_truly_new(new_task), "Completely new", "New application"))
```


```{r}
guess_summarized_d = d %>%
  group_by(new_task, condition, run) %>%
  summarize(guess = head(loss, 1),
            trained = tail(loss, 1)) %>%
  ungroup() %>%
  gather(type, loss, guess, trained) %>%
  group_by(new_task, condition, type) %>%
  summarize(loss_sd = sd(loss),
            loss = mean(loss),
            loss_ci_lo = loss - 1.96 * loss_sd/sqrt(n()),
            loss_ci_hi = loss + 1.96 * loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(type=factor(type,
                     levels=c("guess", "trained")))
```

```{r}
ggplot(data=guess_summarized_d %>% filter(!(new_task %in% c("X0")), type == "guess"), aes(x=new_task, y=loss, fill=condition)) +
  geom_bar(stat="identity", position="dodge") + 
  geom_errorbar(aes(ymin=loss_ci_lo, ymax=loss_ci_hi), position="dodge", width=0.5) +
  scale_fill_brewer(palette="Dark2") +
  labs(x="New task", y="Proportion wrong") +
  geom_hline(yintercept=0.5, alpha=0.5, linetype=2)
```
```{r}
ggsave("plots/meta/meta_res.png")
```
```{r}
ggplot(data=guess_summarized_d %>% filter(!(new_task %in% c("X0")), type == "trained"), aes(x=new_task, y=loss, fill=condition)) +
  geom_bar(stat="identity", position="dodge") + 
  geom_errorbar(aes(ymin=loss_ci_lo, ymax=loss_ci_hi), position="dodge", width=0.5) +
  scale_fill_brewer(palette="Dark2") +
  labs(x="New task", y="Proportion wrong") +
  geom_hline(yintercept=0.5, alpha=0.5, linetype=2)
```
```{r}
ggsave("plots/meta/meta_res_final.png")
```
# embeddings

```{r}
for (emb_type in c("guess", "final")) {
  emb_d = data.frame()
  for (run_i in 0:(nruns-1)) {
    filename = sprintf("meta_results/run%i_%s_embeddings.csv", run_i, emb_type)
    if (!file.exists(filename)) {
      next
    }
    this_d = read.csv(filename, header=T)
    this_d$run = run_i
    emb_d = bind_rows(emb_d, this_d)
  }
  pcs = prcomp(emb_d %>% select(-dimension, -run, -one_of(meta_mapping_tasks), -one_of(meta_classification_tasks)), center=T, scale=T)
  pc_d = data.frame(pcs$rotation)
  pc_d$task = row.names(pc_d)
  ggplot(pc_d, aes(x=PC1, y=PC2, color=task)) +
    geom_point() +
    geom_text(aes(label=task)) 
  ggsave(sprintf("plots/meta/PCA_%s.png", emb_type), width=20, height=7)
  pcs = prcomp(emb_d %>% select(-dimension, -run), center=T, scale=T)
  pc_d = data.frame(pcs$rotation)
  pc_d$task = row.names(pc_d)
  ggplot(pc_d, aes(x=PC1, y=PC2, color=task)) +
    geom_point() +
    geom_text(aes(label=task)) 
  ggsave(sprintf("plots/meta/PCA_full_%s.png", emb_type), width=20, height=7)
}
```

```{r}
emb_type = "guess"
emb_d = data.frame()
for (meta_task in c("None", meta_mapping_tasks)) {
  for (run_i in 0:(nruns-1)) {
    if (meta_task == "None") {
      filename = sprintf("meta_results/run%i_%s_embeddings.csv", run_i, emb_type)
      if (!file.exists(filename)) {
        next 
      }
      this_d = read.csv(filename, header=T)
    } else {
      filename = sprintf("meta_results/run%i_%s_%s_embeddings.csv", run_i, meta_task, emb_type)
      if (!file.exists(filename)) {
        next 
      }
      this_d = read.csv(filename, header=T)
    }
    this_d$run = run_i
    this_d$meta_task = meta_task
    emb_d = bind_rows(emb_d, this_d)
  }
}
```

```{r}
classification_mapped = c("NOT_isAND", "NOT_isXOR", "NOT_isX0")
mapping_mapped = c("ID_NOT", "NOT_ID", "NOT_NOT")
emb_dist_d = data.frame()
for (run_i in unique(emb_d$run)) {
  emb_matrix = emb_d %>%
    filter(run == run_i) %>% 
    select(-run) %>%
    gather(task, value, -c(dimension, meta_task)) %>%
    unite(meta_and_task, meta_task, task) %>%
    spread(meta_and_task, value) %>%
    select(-dimension) %>%
    as.matrix(.) %>%
    dist(.) %>% 
    as.matrix(.)
  
  # nrows = dim(emb_matrix)[1]
  # ncols = dim(emb_matrix)[2]
  # emb_matrix = emb_matrix * matrix(rep(1/sqrt(colSums(emb_matrix^2)), each=nrows), nrow=nrows, ncol=ncols)
  # 
  # emb_dist_matrix = t(emb_matrix) %*% emb_matrix
  
  for (mapped in classification_mapped) {
    this_d = as.data.frame(emb_dist_matrix[mapped, c("None_NOT", "None_ID", "None_isAND", "None_isNOTAND", "None_isNOTX0", "None_isX0", "None_isXOR", "None_isNOTXOR", "None_isOR")])
    names(this_d) = c("distance")
    this_d$mapped = mapped
    this_d$run = run_i
    this_d$target =row.names(this_d)
    emb_dist_d = bind_rows(emb_dist_d, this_d)
  }
  
  for (mapped in mapping_mapped) {
    this_d = as.data.frame(emb_dist_matrix[mapped, c("None_ID", "None_NOT", "ID_ID", "ID_NOT", "NOT_ID", "NOT_NOT")])
    names(this_d) = c("distance")
    this_d$mapped = mapped
    this_d$run = run_i
    this_d$target =row.names(this_d)
    emb_dist_d = bind_rows(emb_dist_d, this_d)
  }
}
```

```{r}
ggplot(emb_dist_d %>% filter(mapped %in% classification_mapped),
       aes(x=target, fill=target, y=distance)) +
  geom_bar(stat="identity") +
  facet_grid(~mapped)
```

```{r}
ggplot(emb_dist_d %>% filter(mapped %in% mapping_mapped),
       aes(x=target, fill=target, y=distance)) +
  geom_bar(stat="identity") +
  facet_grid(~mapped)
```

# meta-tasks


```{r}
meta_d = data.frame()
for (run_i in 0:(nruns-1)) {
  filename = sprintf("meta_results/run%i_new_meta_true_losses.csv", run_i)
  if (!file.exists(filename)) {
    next 
  }    
  this_d = read.csv(filename, header=T)
  this_d$run = run_i
  this_d = this_d %>% 
    gather(mapping, loss, -c(run, epoch)) %>%
    mutate(is_new = grepl("new", mapping),
           is_truly_new = task_truly_new(mapping),
           condition = ifelse(is_truly_new, "completely_new",
                       ifelse(is_new, "new_application",
                              "old"))) %>%
    separate(mapping, c("meta_task", "original_task", "relevant"), sep="\\.", extra="drop")

  meta_d = bind_rows(meta_d, this_d)
}
```

```{r}
meta_bookend_summarized_d = meta_d %>%
#  filter(original_task != "XOR") %>%
  group_by(run) %>%
  filter(epoch == 0 | epoch == max(epoch)) %>%
  ungroup() %>%
  mutate(time=ifelse(epoch==0, "guess", "final")) %>%
  select(-epoch) %>%
  group_by(time, meta_task, condition) %>%
  summarize(mean_loss = mean(loss),
            se_loss = sd(loss)/sqrt(n())) %>%
  ungroup() %>%
  mutate(cihi=mean_loss + 1.96*se_loss, 
         cilo=mean_loss - 1.96*se_loss)
```

```{r}
ggplot(data=meta_bookend_summarized_d %>% filter(time=="guess"), aes(x=meta_task, fill=condition, y=mean_loss)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=cilo, ymax=cihi), position="dodge") +
  scale_fill_brewer(palette="Dark2") +
  labs(x="New task", y="Mean proportion wrong") +
  geom_hline(yintercept=0.5, alpha=0.5, linetype=2) 
```

```{r}
ggsave("plots/meta/meta_guess_performance_summarized.png")
```

```{r}
meta_bookend_d = meta_d %>%
  group_by(run) %>%
  filter(epoch == 0 | epoch == max(epoch)) %>%
  ungroup() %>%
  mutate(time=ifelse(epoch==0, "guess", "final")) %>%
  select(-epoch) %>%
  group_by(time, meta_task, original_task, condition) %>%
  summarize(mean_loss = mean(loss),
            se_loss = sd(loss)/sqrt(n())) %>%
  ungroup() %>%
  mutate(cihi=mean_loss + 1.96*se_loss, 
         cilo=mean_loss - 1.96*se_loss)
```

```{r}
ggplot(data=meta_bookend_d %>% filter(time=="guess"), aes(x=original_task, fill=condition, y=mean_loss)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(aes(ymin=cilo, ymax=cihi), position="dodge") +
  scale_fill_brewer(palette="Dark2") +
  geom_hline(yintercept=0.5, alpha=0.5, linetype=2) +
  labs(x="New task", y="Proportion wrong") +
  facet_grid(~ meta_task) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}

ggsave("plots/meta/meta_guess_performance.png")
```

